MirrorContraption = Data.define(:grid) do
  def self.parse(text)
    new(text.lines(chomp: true))
  end

  def height = grid.length
  def width = grid.first.length

  Position = Data.define(:row, :col) do
    def north = with(row: row - 1)
    def east  = with(col: col + 1)
    def south = with(row: row + 1)
    def west  = with(col: col - 1)
  end

  def tile_at(pos)
    pos => row: row, col: col
    if (0...height).include?(row) && (0...width).include?(col)
      grid[row][col]
    end
  end

  def tiles_energized(pos = Position.new(0, 0), dir = :east, tiles = Set.new, memo = Set.new)
    return tiles if memo.include?([pos, dir])
    memo << [pos, dir]
    tile = tile_at(pos)
    return tiles unless tile
    tiles << pos
    new_dir = dir
    other_new_dir = nil
    case tile_at(pos)
    when '/'
      case dir
      when :north then new_dir = :east
      when :south then new_dir = :west
      when :east  then new_dir = :north
      when :west  then new_dir = :south
      end
    when '\\'
      case dir
      when :north then new_dir = :west
      when :south then new_dir = :east
      when :east  then new_dir = :south
      when :west  then new_dir = :north
      end
    when '|'
      case dir
      when :east, :west
        new_dir = :north
        other_new_dir = :south
      end
    when '-'
      case dir
      when :north, :south
        new_dir = :east
        other_new_dir = :west
      end
    end
    tiles_energized(pos.send(new_dir), new_dir, tiles, memo)
    tiles_energized(pos.send(other_new_dir), other_new_dir, tiles, memo) if other_new_dir
    tiles
  end

  def show_tiles_energized
    new_grid = grid.map(&:dup)
    puts new_grid
    puts
    tiles_energized.each do |pos|
      new_grid[pos.row][pos.col] = '#'
    end
    puts new_grid
  end

  def num_tiles_energized
    tiles_energized.length
  end
end

if defined? DATA
  contraption = MirrorContraption.parse <<END
.|...\\....
|.-.\\.....
.....|-...
........|.
..........
.........\\
..../.\\\\..
.-.-/..|..
.|....-|.\\
..//.|....
END
  contraption.show_tiles_energized

  return unless 46 == contraption.num_tiles_energized

  contraption = MirrorContraption.parse(DATA.read)
  puts contraption.num_tiles_energized
end

__END__
\....../.-...--.|....\../.......|......|.\......../..................|......|......................|..........
...................|........../.........-..................................../\|....|.........................
................/..../.........\.....-.................................../................./...............|..
..........|.....................\......-..-...|......-|..............|.......\.........|...........--.......|.
.\................................................/............../...|......|............-...................-
.......................|..................-..|...\...|...................................|.......-......../...
...................................../.....|....|...-................-........\....-..........................
.......--.....-.....-.-......\..../....|........\......../..|...................../...........................
.................-......\......../.....-|..............|....-........-....\......|...-.......-....../.........
...........|......-.............\.../.........\...........|.....-...../....................../.........|-.....
...................../........|...-.......-.............../\\...../..\...........................\............
........|.............................................................-....|.........-........-..../.....|....
....././...-.......|...../........../.|..\.....||.............................|............\..................
......\...|.....|..........................-......|.....-........................................./..|.......|
..|../....|..-.-............-..../|.\........................-../...\............................-\..|..-.....
.|..|....\........\.|.-....\....................\...\......../....................../..//...|.....//..-./.....
....................|.............../...|..|.|......./..........................-..............|..|.../.......
........\.................|/.......-...........|/....|.../.|.\...................-...........|.............|..
.........-..|.............\.../....|/.................|/.............\........-..................|...|........
......../........|......\...................|.....\.\.................\......\.........|..................\...
.......\...................|........./...................|.....|......./..../.|.|...-....|........../.........
...............\.|..\......./.....\....../..............\..\...../......\...-.........../\...........-........
......................-.....|......../............../......|.......\..../.............../.../.......|....../..
..............-.\/\.\....................-...\.....................\-../.....\..........\...../......./.......
......./...../....\......../........\..|.................-...................-..........-............../......
.....|..|....|...||.|..../...\......\.|........\...../......................................|..\..............
........-....\........./......|....../.../.......-...................................-|.......................
...................../...../.......................-........\.........\..|./...../.....-..........\...........
...../........\\.\\........................-..-....................\-.|.|-.........................\..........
......................./...........................-.........../.........................../........-/.../....
......-........................./...\........................\....|.../..|../..........-................./....
..-..................-............\........../.......\................................................./......
.../...................|...-.../........................|-.-......./..................-.............\.........
....\...../............../............................-..............-../..........-.....--...................
...-.......-...\...../...............................\................................................|.......
............-.......................\.-\.....\..............\............-.........\..../\...\...-..........\.
\.............|...../\...../....../..........|./...../.......................-..................-.\...........
.-..................-.....-..\..........|..............\..-......-...........//./...-..\.......-../...........
..............|..\..-...\....|.........................-..|...|/.........................-./....../\..|.....-.
...|....\.-...................|.|..................-.....\../..............\............/..........-..........
........../.....|............./............................................|..-......|\.........-........-/.|.
....|../........\..................|...\.........\./....|....-.........-...\....|............................-
-.....................|\............/............\...................-.|........-........../..................
-...|.../....-...../...../............\.................|........................|.......|-...............\-..
..\....................../.\..\.....|.............-.....-....-./......-../..................\.................
../...............|...-..\./.....-....................../................\............-........../.........|..
...|.........\......\.........-..-.|......\...............-......-..............\..........-\......\..........
..|...................\..|.....\.......\...................\............................................/.....
|..|.../.....|..../.......-..................\......../......../.........-....................................
.....\.......................-...\..\.......|........\.............\...|......./-\..........|.....-.\.........
.............................|/|.|.-............./.......|..../.........\\..-.|....|...../.......-..........|.
........|..../.............\.../\...............................................................|.............
..\.-|......|..........................|........./........-..................-......./..........|...-.......\.
/........|....\....../..........||...................|.|...|....................-.|.......\|.\................
............./.......................-..\\.|.../.....|....................\../................................
..................\..................../...........|........\.|........../........./........||.......-/.\.....
........\....-...|..|.......-...-..........................--.......\.../..\.................\................
....-....\......|..../.../......//|...........................|............./.-.|.........\/.|..-............\
-....\..../....................|..\.............\.........-.....\..|.-.\.......-.........|..\.....-...........
........../......\...........././.....-.....|................|.............-|............./...|.......\-......
.................-../............-..............................................-...\.........................
\.....|...................|.../........-..................\.....\/........-...................................
......\......................./................-.........\...-.....-.....|............./...........-..\....\..
......-..//....-........../.............\....\.\.........\...................\..\.............................
|.............-................-......................./.............................\..-.....\............/..
..........|..........................-.|............\......-........\..\.|......|.-........................../
...................|.............-......../..-...............\......../................/..........-\/|..\.....
..../|.|............................./......../.|.\.-.................-............\........|-..-.............
./............../.........-........|.|......|................-.|................/..............\..............
.........-........\..............|/............/....-..../.../.........|.........................\............
.................../.|.\.-....|................................|................./-........-..................
....................\.......\.........//..........-.../..|.....-..-................./...-.....-...............
...........|/.\..-........./...........|.-......-...................................../...................\...
......|....|...........\....-..................-...............-|............-./...............|.......|.....\
..............\...-............/...............|..../....\\../................................/...........-...
../............|..../...................-........-.................|............./..\../....\..-....\..\......
.............\...-..............|............/..........................-...................................|.
.........|...................../....-..........|........./.........|.....-......../..|..............-..../....
.....................\...................../\.................\....../........./..............\.........|.....
..................................\./.-........................|......\.................../...-......\-.......
.......|.......................|............................-.........................../.....................
......\...............-......\...........................|........................./.-........../..../....\...
.../....-|.......-........../..........-......\.............|..-.../.......\.../..../..................-......
........./.............\....-..-...\..--...|.-..-.|...-....-.....\................-/.........|.............-\.
...........|.............\.............\.....|....|.--............|...|.|.............................-/......
../.............|........|................./\..|....../.............|\............\.........\.......|.......|.
-...........-..................-........\...............................-\...................\|......|........
..................../.......-..-...............\..........\..........................................\...../|.
........|........./.......-\.......|............|............../............../......-.....|..................
...........-..........//.....|............\...\................/.........-...-./..|......................-\...
/\........./.|..............|..........|..................-|-.........|........................-..|\.\.-......
............./....../..........|//.....-.....-.../....................|.......\.......-........-...........|..
......................./..........\............./....................\.........-......-\...|..................
.......................-..../../..................-.........-........................\..............|.........
........|..../..../..-|................|.../..........|...........-................\...............-..........
.........|.......\.........................\....|..............\......\....-............................/....-
...........\..........|................................./....................../..............................
........................../.-....................\........................-......|.......|.....-../...........
.............\..-|........-.\|....\............./......\.................|.........\.-......................./
.....--...........\.............\../.....\................................./....-.........|............./.../.
............................|........................\......|/........|...................../.................
.../..|.......................................-.....|.../........................./...-.......................
.|.../../.........-....................-.................../..-......-....|................\..................
......|.....|-....\./.....\.........../.............../...............\...\....\......-.\....-...\-...-./|.../
|.|......./...-....\....\|\...\......\..\.......././.........\........-.....-.........././-....-...-\.........
.......\.|...../.../...../.........\..|./.................\..-\.........\.....|...|.......-...............-/..
............/.-.....................\......./..|................................../|........./.........|..-..|
.../..............././..\.\............|...-.|................/..-..-.........-......-.......//...............
.....\...\-...\.......................-|.........|...-|...........\.........|.....\|...\............-......./.
........|./......|\.................\....|\.................-.../........./..............\-.....-....../....-.
