MirrorContraption = Data.define(:grid) do
  def self.parse(text)
    new(text.lines(chomp: true))
  end

  def height = grid.length
  def width = grid.first.length

  Tile = Data.define(:row, :col) do
    def north = with(row: row - 1)
    def east  = with(col: col + 1)
    def south = with(row: row + 1)
    def west  = with(col: col - 1)
  end

  def get(tile)
    tile => row, col
    if (0...height).include?(row) && (0...width).include?(col)
      grid[row][col]
    end
  end

  Cursor = Data.define(:tile, :dir) do
    def next(dir)
      self.class[tile.send(dir), dir]
    end
  end

  def tiles_energized(cur = Cursor[Tile[0, 0], :east], tiles = Set.new, memo = Set.new)
    return tiles if memo.include?(cur)
    memo << cur
    cur => tile, dir
    tile_contents = get(tile)
    return tiles unless tile_contents
    tiles << tile
    dirs = [dir]
    case tile_contents
    when '/'
      case dir
      when :north then dirs = [:east]
      when :south then dirs = [:west]
      when :east  then dirs = [:north]
      when :west  then dirs = [:south]
      end
    when '\\'
      case dir
      when :north then dirs = [:west]
      when :south then dirs = [:east]
      when :east  then dirs = [:south]
      when :west  then dirs = [:north]
      end
    when '|'
      case dir
      when :east, :west then dirs = [:north, :south]
      end
    when '-'
      case dir
      when :north, :south then dirs = [:east, :west]
      end
    end
    dirs.each { tiles_energized(cur.next(_1), tiles, memo) }
    tiles
  end

  def show_tiles_energized
    new_grid = grid.map { '.' * width }
    tiles_energized.each do |tile|
      tile => row, col
      new_grid[row][col] = '#'
    end
    new_grid
  end

  def num_tiles_energized(...)
    tiles_energized(...).length
  end

  def tiles_in_row(row) = (0...width).map { Tile[row, _1] }
  def tiles_in_col(col) = (0...height).map { Tile[_1, col] }

  def initial_beam_configurations
    [tiles_in_row(0)         .map { Cursor[_1, :south] },
     tiles_in_row(height - 1).map { Cursor[_1, :north] },
     tiles_in_col(0)         .map { Cursor[_1, :east] },
     tiles_in_col(width - 1) .map { Cursor[_1, :west] }].flatten
  end

  def max_tiles_energized
    initial_beam_configurations.map { num_tiles_energized(_1) }.max
  end
end

if defined? DATA
  contraption = MirrorContraption.parse(DATA.read)
  puts contraption.num_tiles_energized
  puts contraption.max_tiles_energized
end

__END__
\....../.-...--.|....\../.......|......|.\......../..................|......|......................|..........
...................|........../.........-..................................../\|....|.........................
................/..../.........\.....-.................................../................./...............|..
..........|.....................\......-..-...|......-|..............|.......\.........|...........--.......|.
.\................................................/............../...|......|............-...................-
.......................|..................-..|...\...|...................................|.......-......../...
...................................../.....|....|...-................-........\....-..........................
.......--.....-.....-.-......\..../....|........\......../..|...................../...........................
.................-......\......../.....-|..............|....-........-....\......|...-.......-....../.........
...........|......-.............\.../.........\...........|.....-...../....................../.........|-.....
...................../........|...-.......-.............../\\...../..\...........................\............
........|.............................................................-....|.........-........-..../.....|....
....././...-.......|...../........../.|..\.....||.............................|............\..................
......\...|.....|..........................-......|.....-........................................./..|.......|
..|../....|..-.-............-..../|.\........................-../...\............................-\..|..-.....
.|..|....\........\.|.-....\....................\...\......../....................../..//...|.....//..-./.....
....................|.............../...|..|.|......./..........................-..............|..|.../.......
........\.................|/.......-...........|/....|.../.|.\...................-...........|.............|..
.........-..|.............\.../....|/.................|/.............\........-..................|...|........
......../........|......\...................|.....\.\.................\......\.........|..................\...
.......\...................|........./...................|.....|......./..../.|.|...-....|........../.........
...............\.|..\......./.....\....../..............\..\...../......\...-.........../\...........-........
......................-.....|......../............../......|.......\..../.............../.../.......|....../..
..............-.\/\.\....................-...\.....................\-../.....\..........\...../......./.......
......./...../....\......../........\..|.................-...................-..........-............../......
.....|..|....|...||.|..../...\......\.|........\...../......................................|..\..............
........-....\........./......|....../.../.......-...................................-|.......................
...................../...../.......................-........\.........\..|./...../.....-..........\...........
...../........\\.\\........................-..-....................\-.|.|-.........................\..........
......................./...........................-.........../.........................../........-/.../....
......-........................./...\........................\....|.../..|../..........-................./....
..-..................-............\........../.......\................................................./......
.../...................|...-.../........................|-.-......./..................-.............\.........
....\...../............../............................-..............-../..........-.....--...................
...-.......-...\...../...............................\................................................|.......
............-.......................\.-\.....\..............\............-.........\..../\...\...-..........\.
\.............|...../\...../....../..........|./...../.......................-..................-.\...........
.-..................-.....-..\..........|..............\..-......-...........//./...-..\.......-../...........
..............|..\..-...\....|.........................-..|...|/.........................-./....../\..|.....-.
...|....\.-...................|.|..................-.....\../..............\............/..........-..........
........../.....|............./............................................|..-......|\.........-........-/.|.
....|../........\..................|...\.........\./....|....-.........-...\....|............................-
-.....................|\............/............\...................-.|........-........../..................
-...|.../....-...../...../............\.................|........................|.......|-...............\-..
..\....................../.\..\.....|.............-.....-....-./......-../..................\.................
../...............|...-..\./.....-....................../................\............-........../.........|..
...|.........\......\.........-..-.|......\...............-......-..............\..........-\......\..........
..|...................\..|.....\.......\...................\............................................/.....
|..|.../.....|..../.......-..................\......../......../.........-....................................
.....\.......................-...\..\.......|........\.............\...|......./-\..........|.....-.\.........
.............................|/|.|.-............./.......|..../.........\\..-.|....|...../.......-..........|.
........|..../.............\.../\...............................................................|.............
..\.-|......|..........................|........./........-..................-......./..........|...-.......\.
/........|....\....../..........||...................|.|...|....................-.|.......\|.\................
............./.......................-..\\.|.../.....|....................\../................................
..................\..................../...........|........\.|........../........./........||.......-/.\.....
........\....-...|..|.......-...-..........................--.......\.../..\.................\................
....-....\......|..../.../......//|...........................|............./.-.|.........\/.|..-............\
-....\..../....................|..\.............\.........-.....\..|.-.\.......-.........|..\.....-...........
........../......\...........././.....-.....|................|.............-|............./...|.......\-......
.................-../............-..............................................-...\.........................
\.....|...................|.../........-..................\.....\/........-...................................
......\......................./................-.........\...-.....-.....|............./...........-..\....\..
......-..//....-........../.............\....\.\.........\...................\..\.............................
|.............-................-......................./.............................\..-.....\............/..
..........|..........................-.|............\......-........\..\.|......|.-........................../
...................|.............-......../..-...............\......../................/..........-\/|..\.....
..../|.|............................./......../.|.\.-.................-............\........|-..-.............
./............../.........-........|.|......|................-.|................/..............\..............
.........-........\..............|/............/....-..../.../.........|.........................\............
.................../.|.\.-....|................................|................./-........-..................
....................\.......\.........//..........-.../..|.....-..-................./...-.....-...............
...........|/.\..-........./...........|.-......-...................................../...................\...
......|....|...........\....-..................-...............-|............-./...............|.......|.....\
..............\...-............/...............|..../....\\../................................/...........-...
../............|..../...................-........-.................|............./..\../....\..-....\..\......
.............\...-..............|............/..........................-...................................|.
.........|...................../....-..........|........./.........|.....-......../..|..............-..../....
.....................\...................../\.................\....../........./..............\.........|.....
..................................\./.-........................|......\.................../...-......\-.......
.......|.......................|............................-.........................../.....................
......\...............-......\...........................|........................./.-........../..../....\...
.../....-|.......-........../..........-......\.............|..-.../.......\.../..../..................-......
........./.............\....-..-...\..--...|.-..-.|...-....-.....\................-/.........|.............-\.
...........|.............\.............\.....|....|.--............|...|.|.............................-/......
../.............|........|................./\..|....../.............|\............\.........\.......|.......|.
-...........-..................-........\...............................-\...................\|......|........
..................../.......-..-...............\..........\..........................................\...../|.
........|........./.......-\.......|............|............../............../......-.....|..................
...........-..........//.....|............\...\................/.........-...-./..|......................-\...
/\........./.|..............|..........|..................-|-.........|........................-..|\.\.-......
............./....../..........|//.....-.....-.../....................|.......\.......-........-...........|..
......................./..........\............./....................\.........-......-\...|..................
.......................-..../../..................-.........-........................\..............|.........
........|..../..../..-|................|.../..........|...........-................\...............-..........
.........|.......\.........................\....|..............\......\....-............................/....-
...........\..........|................................./....................../..............................
........................../.-....................\........................-......|.......|.....-../...........
.............\..-|........-.\|....\............./......\.................|.........\.-......................./
.....--...........\.............\../.....\................................./....-.........|............./.../.
............................|........................\......|/........|...................../.................
.../..|.......................................-.....|.../........................./...-.......................
.|.../../.........-....................-.................../..-......-....|................\..................
......|.....|-....\./.....\.........../.............../...............\...\....\......-.\....-...\-...-./|.../
|.|......./...-....\....\|\...\......\..\.......././.........\........-.....-.........././-....-...-\.........
.......\.|...../.../...../.........\..|./.................\..-\.........\.....|...|.......-...............-/..
............/.-.....................\......./..|................................../|........./.........|..-..|
.../..............././..\.\............|...-.|................/..-..-.........-......-.......//...............
.....\...\-...\.......................-|.........|...-|...........\.........|.....\|...\............-......./.
........|./......|\.................\....|\.................-.../........./..............\-.....-....../....-.
