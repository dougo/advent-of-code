=begin

--- Day 21: Step Counter ---

While you wait, one of the Elves that works with the gardener heard how good you are at solving problems and would
like your help. He needs to get his steps in for the day, and so he'd like to know which garden plots he can reach
with exactly his remaining 64 steps.

He gives you an up-to-date map (your puzzle input) of his starting position (S), garden plots (.), and rocks
(#). For example:

...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........

The Elf starts at the starting position (S) which also counts as a garden plot. Then, he can take one step north,
south, east, or west, but only onto tiles that are garden plots. This would allow him to reach any of the tiles
marked O:

...........
.....###.#.
.###.##..#.
..#.#...#..
....#O#....
.##.OS####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........

Then, he takes a second step. Since at this point he could be at either tile marked O, his second step would allow
him to reach any garden plot that is one step north, south, east, or west of any tile that he could have reached
after the first step:

...........
.....###.#.
.###.##..#.
..#.#O..#..
....#.#....
.##O.O####.
.##.O#...#.
.......##..
.##.#.####.
.##..##.##.
...........

After two steps, he could be at any of the tiles marked O above, including the starting position (either by going
north-then-south or by going west-then-east).

A single third step leads to even more possibilities:

...........
.....###.#.
.###.##..#.
..#.#.O.#..
...O#O#....
.##.OS####.
.##O.#...#.
....O..##..
.##.#.####.
.##..##.##.
...........

He will continue like this until his steps for the day have been exhausted. After a total of 6 steps, he could
reach any of the garden plots marked O:

...........
.....###.#.
.###.##.O#.
.O#O#O.O#..
O.O.#.#.O..
.##O.O####.
.##.O#O..#.
.O.O.O.##..
.##.#.####.
.##O.##.##.
...........

In this example, if the Elf's goal was to get exactly 6 more steps today, he could use them to reach any of 16
garden plots.

However, the Elf actually needs to get 64 steps today, and the map he's handed you is much larger than the example
map.

Starting from the garden plot marked S on your map, how many garden plots could the Elf reach in exactly 64 steps?

=end

require_relative '../util'

class StepCounter
  def self.parse(text)
    lines = text.lines(chomp: true).map(&:chars)
    new(Grid.new(lines))
  end

  def initialize(grid) = @grid = grid
  attr :grid

  def start_pos = grid.each_position.find { grid[_1] == 'S' }

  def empty?(pos) = grid[pos].in?('.S')

  def num_plots_in_steps(steps)
    pos = start_pos
    visited = Set[pos]
    plots_at_steps = [[pos]]
    1.upto(steps) do
      frontier = plots_at_steps.last.flat_map(&:neighbors).to_set
      frontier = (frontier - visited).filter { empty?(_1) }
      visited.merge(frontier)
      plots_at_steps << frontier
    end

    # TOOD: odd steps, start at 1 -- add a failing test
    0.step(by: 2, to: steps).sum { plots_at_steps[_1].length }
  end
end

if defined? DATA
  input = DATA.read
  obj = StepCounter.parse(input)
  puts obj.num_plots_in_steps(64)
end

__END__
...................................................................................................................................
....#...#.......................#.#......###..#.............#................#.....#.....#.#...#.........#.#..........#......#.....
...#.##.#...#.....................#.......#.......#....#...................#....#...........#.#...........#....#...#...............
.#........#.#................#.....#.....#.........#.......................#..#...#........#..#..........##............#...........
.....#.#.....#.....#..........#........#.........#...#..........................#....#.#......#....#.#####.................#.#.....
...........................#...........#...#..#...#...............#.......#......#.#......#.......#.......#.........#.........#....
......#...#.....##.......................#.....................#..............#..#...##...#....#....##....##....#..#...............
..................#...........#.................................#..#.......................#....#.....#................#...........
.#....##......#.............#.#.....#...#..#...#.....#.......#.....#.#..........#..##..........#.........#.........................
...........#.......#.....#................#.....#..............................#.#....#...............#..........................#.
............#.#..............#.......#...................................................#......##....#.......#...##...............
...................#.#......#.....................#........##.#....#...#............#...................#.....##.....#..#.#..#...#.
..........#......#...#...#..#.................#..............#.....................#.........#.#........#.......#.#..............#.
......#.......#...#.#............#.....#.#...................#...........##.......................#...#...##......#..#......#......
.#.............#.....#......#.....#.........#..............##..................................#..#..#.#........#.....#............
......#...............#......#............................#.............##..#.........##.........#.#......#......#..............#..
.........#..............#..................................#.................#..........##.......#........#........##............#.
.....#..........#.....#.#..................##..........#....#.....#...#...#..#........#.............##.......#.....#........##.##..
......#........#.....................#................#......................#...........#...#......#...##.........................
..............#................#..#...................#...###...............................#.#..##........##......##...#.....#....
....#...............##.....#.#........#..............#..#.......#..#..#........#............#..##....#......#.....###..............
.#......................#..#...#....#...........#...#...............#........#............#...#.##....#................##....#...#.
......#.......#.#...#......##.....................#...............#......#.....................##.....#.#.....##.................#.
......##................#....#...#...#.............#..................#.........#...............#...........##.................#...
....#.....#...#.#....#....#.......#.#.........#...###........#.........#.....................#.....#.##...#..##......#...#.........
.................#....#...#....#.#......................#...........#.....#.....#.#.##........#..........#......#..#....#..........
....#...........#.......#....................#.#...#.........#.............#..#..................##............#.#.................
...................#.#.......#...##............#....#...........#.......#........................#...........#.##....##....##......
......#..#.#...#..............#...............................#.....#.#.............#..#............#........#..............#.#....
..#....#...........#...##..##..#........#..#.....#....#...#...#...#....#.#............................#.#.#........................
......#................#.#................#..#....##........#........#....#...#..#.#......#..........##....#...#......#.#.#...#..#.
...#.#..##..#......#......................#................#....................#............................##...#......#..#......
....#...#.##...##.......#................#.#..#........#.#.............#............##.#..........................##......##.......
...#.........###.#.....#............#.........#................#..............#............................#......#.....#..#.......
...###....#.........................#..#...#............................#.....##..#..........#...........#.....#................#..
.............##.....#...............#..........#.....#.............#..#...#..#........#.#.#.............#............#...........#.
.......#..........#..............#.......#..#........#.#...............#................#....#...............#.....................
.............#..#.....................##.....#.#...............................#..#..#..#....#...##............#..#......#.........
................#...#.#.............#............#...........................#...........##...#..#..........#.......#..#........#..
.........#.#.........#...........#.........#..........#...........#.............#..........#..................#...#....#....#..#...
...#.#.....#...#...............#..#......#.......##........#..#......#..#.....#..........#...#.#.............#...#....#.....#......
..#...#..##.....#............#.#......#...#................................#.##.............###....#................##....#......#.
...................................#.#...#.......#.....##....#.#......#..#.............#...........#..#........#.................#.
.......#..................#..#................#.........................#.................#..........#..#.....................#....
..........#...#.##..................#......##..##......#......#......#..##.....#..............#....#.............#...#..##.#...#...
................#.........................#.......#...............#.......#..#....##...#......#....#................#............#.
..#....#..##.#...........#.........##..#..#..#.................##......#...##..................##....#...............#.#..##.......
......#......#...........#....#...#....#.#......................#...........#................#.........#.#..........#.#............
.....#....#..#.......##....................#................#.......#...........#.......#..............#..................#........
..#........#........#.#.....##........#..#.....#.....#......#......#.#............##....#..............#..............#...#........
..#.##........................#..##.#.........#.....#...#............#..............#...#.........#...........#............##......
...#........................#.#....##.#.......#.#.............#....#...#......#.....#.....#..#......#...##...............#.........
......#...........#.................#......#.#......#.......##.#.....#.....#..............#...................#..............#.....
.......#..............#..........#..........#...........#...#........................#..#....#............................#....#...
................#..#.......#....#..##............####....#..#...#................#..............#................................#.
...#..#............#..#........#.......#......#..##...............#..#.#...#......#.........#.................#.#...........#.#....
..#...............#...#..........................#.#.......#..#..........#...#.......#..#....#.#..............................#..#.
...#................................#...#.....#...#........#.......#..#..#..............#...#.....#.......#........................
............##.............#.......#...........#...##......#......#.................#.......###...........#......#...............#.
.......................#...###.........#.....#.................#....##..#............#...........##....#.........#.#..##...........
...........##.....................#....#..#....................#.....................#..........#.....##........#................#.
........#........#.....##........##.........##..#.#..................##..........##...#...##..............#......#.................
...................#.........#.##..#..#.#..#...........##................#.......#......#...#.#........#.#..#......................
.................#..........##.............#.....#.......##..#..#.......##..##...............#..............#......#.##............
............#....#.............##...#.....#..................###..#..#......#............#............##..............#....#.......
.................................................................S.................................................................
............#......#....#........#..#..#.#..................#..#......#................#...........#.#..#....#......#..#.....#.....
................#.......................#...##.........#...............#.#...................##.........#....#..#...........#......
...........#..##..#...........#........##...........#..##..#..#..........#......#..........#....#..#........#.........##...........
.........##..#...#.............#....#...........#...#...#......#..#...............#........#..............#.#....#.................
.#............................#..............#....##.....#..#..#............#.#....#..#......#.....#........#.....#................
...................#...#...........#............#.....##........#....#....#..#....#.........#.#....#.#.....##..#..#....#...........
................#.#...#....#.#....##..#..##...#.......#.#............#.........................###.#.................##............
.#.#.........................#.....................#.......................#.#...#..##...#..#.#.......#...............#.......#..#.
..............#...###...........#....#..#.................#..#......#.#........#.#...#...#..#..#...#.#..#.....................#.#..
.....................................##...............#.#.......#.......#..........#......#.........#..#............#..............
......................#..#.#.#...........#.##.....#...............#...#.........#.....##............##......................#....#.
...................#....#..#.#...#...#.....#.........#..#.......#...........#..#......................#.......#...........#........
.....................#...#.....#.#......#....##..##.##.........#..........#...........###......#......#.......#...............#....
..#.....................#..............#.#..#............#.....#.........#.#..............#................................#.......
.#........#...........##...........................#........#......##............#......#......#......#............................
...........#...................#...##......#...........#...................#...................#.#......#.............#..#...#.....
..........#..........##........##..#.#....#.....#...........##.......#...........#.......##.#........#...#............#..........#.
.........#...........................#...#.##...........#.............##....#...#...#.............#.....#...#.........#............
..#.....#...........................#....#.................#..#....................##..#.##.##....#......#..................#......
.....##...................#......#.#..#.............#........#......#..#.........................#....................#....#...#...
.#...................................#....#........#...#.#...#...........#.#.......#..#..#.......##.#...................#....#.#.#.
.#......#....#....#........................#....................#...#..#...#..#...........#......#..#..............................
..........#.......#..........#.........##...##.....#.......#....#..........#..#......#..................................##.........
...#...........#...............#.#....##......#.....................#....#..........##..#..##....##.#.........#......#.......#.....
.#.................#...........#......#...#........#.........#.##..............#.......#...#.#...#...#..........#..#.#.............
.....#..#...#...#...................#...#..#..#.......#..#................#............#......#...................##..#..........#.
......#.......#...#..............#.##.....#..#........#....#..........#..###...................................#............#......
..#..........#...#..##..#...........##.........##....#..#...#..........#.##.......#.......#..#..#............#.#...#.......##..#...
..#..#....#..##........##...........#.#..................#......#.#.#........#..........#.................................#..#.....
.................#...........................#..#....................#..#.#.#..#....#....#..............#....###.....#...#..##.#...
......#.....#.........#.......................##.....#.......#.#..##....#.....#....#...##...#..#..........#....#..#................
..........#........##...........................#.#..........#................#.....#.#...##.......................#.......#..#....
.........#.....#...........#...........................................................................#.....#...............#.....
.................#.....#..................#...#....#.#............#..##..........#......#.##.............###......#..........#.....
.#...................................................#..#..#.#........#...............#....................#.............#..#......
..#..#......#..#........#..#..............##...........#.#........#.........#..#....................................#.....#........
.#.....#..#.#..##....#...#......................#..........###.#..##.......#.........................#....#........#..#............
..#.......#.#.......#........#.#.............#..........#.........#...#.....................................#........#.##.......#..
...#......#.#......##.##......##.#...........##....#.....#......................#...............#.....##.............#..........#..
.#.#....#...................................##.................#.............##.#................#...#.#...#.............#.....###.
..#..........#.##.###....#...#.......#..............#.......#.................#.#....#..........#.#...#...#..#........#............
.......##.........#....#....##..##............##.........#...........#...##.#.....##..........#.........#............#.#....#.##...
....#...###...........#......#.................#.....#.#.................#.................#......#.............................#..
...#..#...................#..#....#...#.............#.......#.#.........###...#...................#....##..#...........#......#....
.#...............#.............#..##............................#..........##.................#.#.#.##....#.......#.#...#..#.......
..#...........#.....................#..#...........#..#.##..#......####.........#..............................##........###.##.#..
.......#.....#..........#.#.........................#...........#.....#...#....#..............#..........##.#................#.....
.#.....#....#...#....#..........#....................#................#....#...........#....#.....................##...#....#....#.
................##...#....#........#..##.............#............##.#....##............#........#.##............#.#.........#.....
......#.#.#.#....#........................#..................#.#........................#........#.#....................#.....#.#..
......#..#.........#........#....#...#...#...#...............##.......#.#.............................................##...#....#..
......#.#......................#....#..#....................#.......#................#..#..#.#..#...............#.........##.#.....
............#.....................###.......................##.....#.....#........#...#........#.........#..#........#.........#.#.
....#......#..#.................#........#..#...#.........#.....#.#.................#.............#..#.....#........#....#.........
.#..#......#..#.....................#.....#......#..............................#..#..................#..#..##...........#.........
...#.............#...........#...................#.#........#.....#............#............................#..#...................
.....#....#.........#..#.#..............#.#..#.##....#.......##..........................#....#...........#...............###......
......#................#..#....................#.....#........................#.#....#.......#................#.............#...#..
..........#...........#.........#.................#.........................#........#..#.............#......#..........#..#.......
.....#...#...................#.....#.........##..#.....................................#.....#.#....#........#...#..#....#.........
..#.#.......#...##..#........#..##...##.#...#...........#.........................#.....#........#..................#....#.....#.#.
.#.........................#.............#.......................................#..........##....#..#####.#.#.................#...
.#.#...........#.....#.##.....#...............#....#.....#.#.................#..#.....#...#...........#......#...#............#..#.
...#...........#..#............#.......#.#.........#..##................#.#.......#............#.................#.....##..........
...................................................................................................................................
