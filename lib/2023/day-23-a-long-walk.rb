=begin

--- Day 23: A Long Walk ---

There's a map of nearby hiking trails (your puzzle input) that indicates paths (.), forest (#), and steep slopes
(^, >, v, and <).

For example:

#.#####################
#.......#########...###
#######.#########.#.###
###.....#.>.>.###.#.###
###v#####.#v#.###.#.###
###.>...#.#.#.....#...#
###v###.#.#.#########.#
###...#.#.#.......#...#
#####.#.#.#######.#.###
#.....#.#.#.......#...#
#.#####.#.#.#########v#
#.#...#...#...###...>.#
#.#.#v#######v###.###v#
#...#.>.#...>.>.#.###.#
#####v#.#.###v#.#.###.#
#.....#...#...#.#.#...#
#.#########.###.#.#.###
#...###...#...#...#.###
###.###.#.###v#####v###
#...#...#.#.>.>.#.>.###
#.###.###.#.###.#.#v###
#.....###...###...#...#
#####################.#

You're currently on the single path tile in the top row; your goal is to reach the single path tile in the bottom
row. Because of all the mist from the waterfall, the slopes are probably quite icy; if you step onto a slope tile,
your next step must be downhill (in the direction the arrow is pointing). To make sure you have the most scenic
hike possible, never step onto the same tile twice. What is the longest hike you can take?

In the example above, the longest hike you can take is marked with O, and your starting position is marked S:

#S#####################
#OOOOOOO#########...###
#######O#########.#.###
###OOOOO#OOO>.###.#.###
###O#####O#O#.###.#.###
###OOOOO#O#O#.....#...#
###v###O#O#O#########.#
###...#O#O#OOOOOOO#...#
#####.#O#O#######O#.###
#.....#O#O#OOOOOOO#...#
#.#####O#O#O#########v#
#.#...#OOO#OOO###OOOOO#
#.#.#v#######O###O###O#
#...#.>.#...>OOO#O###O#
#####v#.#.###v#O#O###O#
#.....#...#...#O#O#OOO#
#.#########.###O#O#O###
#...###...#...#OOO#O###
###.###.#.###v#####O###
#...#...#.#.>.>.#.>O###
#.###.###.#.###.#.#O###
#.....###...###...#OOO#
#####################O#

This hike contains 94 steps. (The other possible hikes you could have taken were 90, 86, 82, 82, and 74 steps
long.)

Find the longest hike you can take through the hiking trails listed on your map. How many steps long is the longest
hike?

=end

require_relative '../util'

class ALongWalk
  def self.parse(text)
    new(Grid.parse(text))
  end

  def initialize(grid)
    @grid = grid
  end

  attr :grid

  def empty?(pos) = grid[pos].in?('.<^>v'.chars)

  def empty_pos(row) = grid.col_range.map { Position[row,_1] }.find { empty?(_1) }

  def direction(pos)
    case grid[pos]
    when '<' then WEST
    when '>' then EAST
    when '^' then NORTH
    when 'v' then SOUTH
    end
  end

  State = Data.define(:pos, :prev_pos)

  def neighbors(pos)
    dir = direction(pos)
    dir ? [pos.move(dir)] : pos.neighbors
  end

  def next_states(state)
    posns = neighbors(state.pos).reject { _1 == state.prev_pos || !empty?(_1) }
    posns.map { State[_1, state.pos] }
  end

  def longest_hike_steps
    # Google says, if the graph is acyclic, use shortest path algorithm with negative weights.
    # The example seems to be acyclic (obeying the slope constraints), but then why do the instructions specify
    # that you can't retrace your steps?

    origin, destination = empty_pos(0), empty_pos(grid.height - 1)
    start_state = State[origin, nil]

    total_steps = Hash.new(Float::INFINITY)
    frontier = Hash.new { |h,k| h[k] = Set[] }

    total_steps[start_state] = 0
    frontier[0] << start_state 

    end_states = []
    loop do
      current_steps = frontier.keys.min
      min_frontier = frontier.delete(current_steps)
      break if min_frontier.empty?
      min_frontier.each do |state|
        end_states << state if state.pos == destination
        next_states(state).each do |dest|
          total_steps_to_dest = total_steps[dest]
          total_steps_after_stepping = current_steps - 1
          if total_steps_after_stepping < total_steps_to_dest
            frontier[total_steps_to_dest].delete(dest)
            total_steps[dest] = total_steps_after_stepping
            frontier[total_steps_after_stepping] << dest
          else
            frontier[total_steps_to_dest] << dest
          end
        end
      end
    end

    end_states.map { -total_steps[_1] }.max
  end
end

if defined? DATA
  input = DATA.read
  obj = ALongWalk.parse(input)
  puts obj.longest_hike_steps
end

__END__
#.###########################################################################################################################################
#.###.......#...#...#.....###...#...............###...#####...#...#...#...#...#.....#...#.........#.........#...........#...###...#.........#
#.###.#####.#.#.#.#.#.###.###.#.#.#############.###.#.#####.#.#.#.#.#.#.#.#.#.#.###.#.#.#.#######.#.#######.#.#########.#.#.###.#.#.#######.#
#...#.....#...#.#.#.#...#...#.#.#.......#.......#...#...###.#.#.#.#.#.#.#.#.#...#...#.#.#.......#.#.#.......#.........#.#.#.###.#.#.#.......#
###.#####.#####.#.#.###.###.#.#.#######.#.#######.#####.###.#.#.#.#.#.#.#.#.#####.###.#.#######.#.#.#.###############.#.#.#.###.#.#.#.#######
#...#.....#...#...#...#...#.#.#.#...###.#.....###.#.....#...#.#.#.#.#.#.#.#.#.....###.#.#.......#.#.#.....###.........#.#.#.....#.#.#.#...###
#.###.#####.#.#######.###.#.#.#.#.#.###.#####.###.#.#####.###.#.#.#.#.#.#.#.#.#######.#.#.#######.#.#####.###.#########.#.#######.#.#.#.#.###
#...#.#.....#.........#...#...#...#.>.>.#.....#...#.#...#.#...#.#...#.#.#.#.#.....#...#.#.......#.#.#.....#...#.....#...#.......#...#...#...#
###.#.#.###############.#############v###.#####.###.#.#.#.#.###.#####.#.#.#.#####.#.###.#######.#.#.#.#####.###.###.#.#########.###########.#
###...#...........#...#...........###...#...###...#.#.#.#.#.###.#.....#.#...#.....#...#.#...###.#.#.#.#...#.....#...#.#...#...#.#...........#
#################.#.#.###########.#####.###.#####.#.#.#.#.#.###.#.#####.#####.#######.#.#.#.###.#.#.#.#.#.#######.###.#.#.#.#.#.#.###########
#.................#.#.#...#.......#.....###.#...#.#...#...#.>.>.#.....#.#...#.#...#...#.#.#.#...#.#.#.#.#.#...###...#.#.#.#.#.#.#.......#####
#.#################.#.#.#.#.#######.#######.#.#.#.###########v#######.#.#.#.#.#.#.#.###.#.#.#.###.#.#.#.#.#.#.#####.#.#.#.#.#.#.#######.#####
#.................#.#.#.#.#.......#.#...###...#.#...#.........###.....#.#.#...#.#.#...#.#.#.#...#.#.#.#.#.#.#.#.>.>.#...#.#.#.#.#.....#.....#
#################.#.#.#.#.#######.#.#.#.#######.###.#.###########.#####.#.#####.#.###.#.#.#.###.#.#.#.#.#.#.#.#.#v#######.#.#.#.#.###.#####.#
#.................#.#.#.#.#...#...#...#.......#...#.#...........#...#...#...#...#.###.#.#.#.#...#.#.#.#.#...#...#.......#...#...#...#.#.....#
#.#################.#.#.#.#.#.#.#############.###.#.###########.###.#.#####.#.###.###.#.#.#.#.###.#.#.#.###############.###########.#.#.#####
#...#.......#...###.#.#.#.#.#...#.............###.#...#.......#...#.#.#.....#...#.#...#.#.#.#.###...#.#.#.....###.....#...#.....###.#...#####
###.#.#####.#.#v###.#.#.#.#.#####.###############.###.#.#####.###.#.#.#.#######.#.#.###.#.#.#.#######.#.#.###.###.###.###.#.###.###.#########
###...#...#...#.>.#.#.#.#.#.#...#.............###.....#.#...#.....#...#.#.>.>...#.#...#...#.#.....#...#.#...#...#...#.#...#...#.#...###...###
#######.#.#####v#.#.#.#.#.#.#.#.#############.#########.#.#.###########.#.#v#####.###.#####.#####.#.###.###.###.###.#.#.#####.#.#.#####.#.###
#.......#.......#...#.#.#...#.#.....#...#...#.....###...#.#...........#.#.#.....#...#.#...#.#...#.#.#...###...#.....#...#.....#...#.....#...#
#.###################.#.#####.#####.#.#.#.#.#####.###.###.###########.#.#.#####.###.#.#.#.#.#.#.#.#.#.#######.###########.#########.#######.#
#.#.....#...........#...#...#.....#.#.#.#.#.#...#...#.....#.........#.#...#.....###...#.#.#...#...#...###...#.......#...#...........#...#...#
#.#.###.#.#########.#####.#.#####.#.#.#.#.#.#.#.###.#######.#######.#.#####.###########.#.###############.#.#######.#.#.#############.#.#.###
#.#.#...#.#...#.....#.....#.......#...#...#...#.....#...###.......#.#.....#...###.......#...#...#...#...#.#.........#.#.#...#.....#...#...###
#.#.#.###.#.#.#.#####.###############################.#.#########.#.#####.###.###.#########.#.#.#.#.#.#.#.###########.#.#.#.#.###.#.#########
#...#.....#.#.#.....#.#...........................#...#...#...#...#.......###...#.......#...#.#.#.#.#.#.#.....#.....#.#...#.#.#...#.........#
###########.#.#####.#.#.#########################.#.#####.#.#.#.###############.#######.#.###.#.#.#.#.#.#####.#.###.#.#####.#.#.###########.#
#.......#...#.....#.#...#...........#...#...#.....#.....#...#.#.......#...#...#...#...#.#.###.#.#.#.#.#.#...#.#...#.#...#...#.#.#...#...#...#
#.#####.#.#######.#.#####.#########.#.#.#.#.#.#########.#####.#######.#.#.#.#.###.#.#.#.#.###.#.#.#.#.#.#.#.#v###.#.###.#.###.#.#.#.#v#.#.###
#.....#.#.......#...#...#.........#.#.#.#.#...###.......#...#.........#.#.#.#.....#.#...#...#.#.#.#...#.#.#.>.>...#.#...#.#...#.#.#.>.#...###
#####.#.#######.#####.#.#########.#.#.#.#.#######.#######.#.###########.#.#.#######.#######.#.#.#.#####.#.###v#####.#.###.#.###.#.###v#######
#...#.#.........#...#.#.#...#.....#.#.#.#...#...#.......#.#...#...#...#.#...#...###.....#...#.#.#.#.....#.#...#...#.#...#...#...#.#...###...#
#.#.#.###########.#.#.#.#.#.#.#####.#.#.###.#.#.#######.#.###.#.#.#.#.#.#####.#.#######.#.###.#.#.#.#####.#.###.#.#.###.#####.###.#.#####.#.#
#.#...#...#...###.#.#.#.#.#.#.....#...#.....#.#.#.....#...###...#.#.#.#.......#.#.....#.#.....#...#.......#.....#.#.#...#.....#...#...###.#.#
#.#####.#v#.#.###.#.#.#.#.#.#####.###########.#.#.###.###########.#.#.#########.#.###.#.#########################.#.#.###.#####.#####.###.#.#
#.#...#.#.>.#...#.#.#.#.#.#.#.....#...#...###.#.#...#.###...#...#...#.#...#...#.#...#.#.........#.......###...#...#.#...#.#...#.....#.....#.#
#.#.#.#.#v#####.#.#.#.#.#.#.#v#####.#.#.#.###.#.###.#.###.#.#.#.#####.#.#.#.#.#v###.#.#########.#.#####.###.#.#.###.###.#.#.#.#####.#######.#
#...#...#.....#...#.#.#.#.#.>.>.#...#.#.#...#.#...#.#.#...#.#.#.#.....#.#...#.>.>.#.#...#.......#.....#.#...#.#...#.#...#...#.......#.......#
#############.#####.#.#.#.###v#.#.###.#.###.#.###.#.#.#.###.#.#.#.#####.#######v#.#.###.#.###########.#.#.###.###.#.#.###############.#######
#.............#...#.#.#.#.###.#.#.#...#.#...#.#...#.#.#...#.#.#.#.#...#...#.....#...###.#.....#.......#.#...#.#...#.#.#.............#...#...#
#.#############.#.#.#.#.#.###.#.#.#.###.#.###.#.###.#.###.#.#.#.#v#.#.###.#.###########.#####.#.#######.###.#.#.###.#.#.###########.###.#.#.#
#...#...#...###.#.#...#.#.#...#...#.#...#.....#.#...#.#...#.#.#.>.>.#.....#...#...#...#.......#...#...#.#...#.#...#.#.#.#.....#...#.....#.#.#
###.#.#.#.#.###.#.#####.#.#.#######.#.#########.#.###.#.###.#.###v###########.#.#.#.#.###########.#.#.#.#.###.###.#.#.#.#.###.#.#.#######.#.#
###...#...#...#.#.###...#.#.#.....#...#.....#...#...#...###...###.....#.....#...#...#.....#...#...#.#.#...###.....#...#...###...#...#.....#.#
#############.#.#.###.###.#.#.###.#####.###.#.#####.#################.#.###.#############.#.#.#.###.#.#############################.#.#####.#
#.............#.#...#.....#.#.#...#...#...#.#.......###...#...#...#...#...#.#.............#.#...#...#.................#.............#.#.....#
#.#############.###.#######.#.#.###.#.###.#.###########.#.#.#.#.#.#.#####.#.#.#############.#####.###################.#.#############.#.#####
#...........#...###.....###...#...#.#.#...#...###...#...#.#.#...#...#.....#.#.............#.#...#.#...........#...#...#.....#...#.....#.....#
###########.#.#########.#########.#.#.#.#####.###.#.#.###.#.#########.#####.#############.#.#.#.#.#.#########.#.#.#.#######.#.#.#.#########.#
#...........#.#.........#...#...#...#...#.....#...#...#...#.........#.....#...............#...#...#.........#...#...#...###...#...#.........#
#.###########.#.#########.#.#.#.#########v#####.#######.###########.#####.#################################.#########.#.###########.#########
#...#.........#.........#.#.#.#.#.......>.>...#...#.....#.....#...#...#...#...................#...###.....#.#...#...#.#.#...#.....#.#.......#
###.#.#################.#.#.#.#.#.#######v###.###.#.#####v###.#.#.###.#.###.#################.#.#.###.###.#.#.#.#.#.#.#.#.#.#.###.#.#.#####.#
###...#...#...#...#...#.#.#...#.#.#.....#.###...#.#.#...>.>.#...#.....#...#.#.....#...........#.#.#...###...#.#.#.#.#.#.#.#.#...#.#...#.....#
#######.#.#.#.#.#.#.#.#.#.#####.#.#.###.#.#####.#.#.#.###v#.#############.#.#.###.#.###########.#.#.#########.#.#.#.#.#.#.#.###.#.#####.#####
#...#...#...#...#...#...#.....#...#...#.#.#.....#.#.#.#...#.#.....#.....#...#...#.#.....#...###.#.#.........#.#.#.#.#.#.#.#.#...#...#...#...#
#.#.#.#######################.#######.#.#.#.#####.#.#.#.###.#.###.#.###.#######.#.#####.#.#.###.#.#########.#.#.#.#.#.#.#.#.#.#####.#.###.#.#
#.#...#...............###...#...#.....#.#.#.#...#.#.#.#...#.#.#...#.#...#...#...#.......#.#.#...#.###.......#.#.#.#.#.#.#.#.#.....#.#...#.#.#
#.#####.#############.###.#.###.#.#####.#.#.#.#.#.#.#.###.#.#.#.###.#.###.#.#.###########.#.#.###.###v#######.#.#.#.#.#.#.#.#####.#.###v#.#.#
#.#...#.#.............#...#.....#.....#...#.#.#.#.#...#...#...#.....#...#.#.#.......#...#.#.#...#.#.>.>...#...#.#.#.#.#.#.#...#...#...>.#.#.#
#.#.#.#.#.#############.#############.#####.#.#.#.#####.###############.#.#.#######.#.#.#.#.###.#.#.#v###.#.###.#.#.#.#.#.###.#.#######v#.#.#
#...#...#...........###.......#...#...#...#...#.#.#.....#...###.........#.#.###...#.#.#.#.#.#...#...#...#.#.###...#.#.#...###...###...#...#.#
###################v#########.#.#.#.###.#.#####.#.#.#####.#.###.#########.#.###.#.#v#.#.#.#.#.#########.#.#.#######.#.#############.#.#####.#
#.................#.>.#...#...#.#.#.....#...###...#.....#.#...#.........#.#.....#.>.>.#.#.#.#.......###.#...#...#...#...#...#...#...#.#...#.#
#.###############.#v#.#.#.#.###.#.#########.###########.#.###.#########.#.#########v###.#.#.#######.###.#####.#.#.#####.#.#.#.#.#.###.#.#.#.#
#.......#.......#...#...#.#.#...#.....#.....#...#.......#...#...#.....#.#.#.........#...#.#.#.....#.#...#...#.#.#...#...#.#.#.#.#...#.#.#...#
#######.#.#####.#########.#.#.#######.#.#####.#.#.#########.###.#.###.#.#.#.#########.###.#.#.###.#.#.###.#.#.#.###.#.###.#.#.#.###.#.#.#####
#.......#.#.....#.......#.#.#...#...#...#####.#.#...........###...#...#.#.#...#.....#...#.#.#...#...#...#.#.#.#...#.#.#...#...#.....#.#.....#
#.#######.#.#####.#####.#.#.###.#.#.#########.#.###################.###.#.###.#.###.###.#.#.###.#######.#.#.#.###.#.#.#.#############.#####.#
#...#.....#.......#.....#.#.#...#.#...........#.....#...............###...###...###...#.#.#.....#...###...#...#...#...#.#...#.......#.#...#.#
###.#.#############.#####.#.#.###.#################.#.###############################.#.#.#######.#.###########.#######.#.#.#.#####.#.#.#.#.#
#...#.#.............#...#...#...#.#...#.....#.......#.......................###.......#.#.#.....#.#.#####.......#...###...#.#.#.....#...#.#.#
#.###.#.#############.#.#######.#.#.#.#.###.#.#############################.###.#######.#.#.###.#.#.#####.#######.#.#######.#.#.#########.#.#
#.....#...............#...#...#...#.#...###...#...#...#...#.................#...#...###...#.#...#.#.#.....#...###.#.###...#...#.........#.#.#
#########################.#.#.#####.###########.#.#.#.#.#.#.#################.###.#.#######.#.###.#.#.#####.#.###.#.###.#.#############.#.#.#
###...###...#.............#.#.#...#.......#...#.#.#.#...#.#.................#...#.#...###...#...#.#.#.....#.#.#...#.....#.#.............#.#.#
###.#.###.#.#.#############.#.#.#.#######.#.#.#.#.#.#####.#################.###.#.###.###.#####.#.#.#####.#.#.#.#########.#.#############.#.#
#...#.....#...#.......#...#.#...#.........#.#.#.#.#.....#.#...###...........###...###...#.....#.#.#.#...#...#...#.........#.............#.#.#
#.#############.#####.#.#.#.###############.#.#.#.#####.#.#.#.###v#####################.#####.#.#.#.#.#.#########v#####################.#.#.#
#.........#...#.#.....#.#.#.#...#.........#.#.#.#...#...#.#.#...>.>.###...###...#...###.#...#.#.#.#.#.#...#...#.>.>.......#.............#...#
#########.#.#.#.#.#####.#.#.#.#.#.#######.#.#.#.###.#.###.#.#####v#.###.#.###.#.#.#.###v#.#.#.#.#.#.#.###.#.#.#.#v#######.#.#################
#...#...#...#...#...###.#.#...#.#.#.......#.#.#.###...###...#...#.#.#...#...#.#.#.#.#.>.>.#...#.#.#.#...#.#.#...#.#.......#.........###.....#
#.#.#.#.###########v###.#.#####.#.#.#######.#.#.#############.#.#.#.#.#####.#.#.#.#.#.#v#######.#.#.###.#.#.#####.#.###############.###.###.#
#.#.#.#...###...###.>...#...###...#.#...#...#.#...#...#...#...#.#.#.#.....#...#...#...#.....#...#.#.#...#...#...#.#.#...###...#...#...#.#...#
#.#.#.###.###.#.###v#######.#######.#.#.#.###.###.#.#.#.#.#.###.#.#.#####.#################.#.###.#.#.#######.#.#.#.#.#.###.#.#.#.###.#.#.###
#.#.#...#.#...#.#...#.......#...###.#.#.#.#...#...#.#...#...#...#.#.#...#.#...........#...#.#.....#.#.#.......#.#.#.#.#...#.#.#.#.....#.#.###
#.#.###.#.#.###.#.###.#######.#.###v#.#.#.#.###.###.#########.###.#.#.#.#.#.#########.#.#.#.#######.#.#.#######.#.#.#.###.#.#.#v#######.#.###
#.#.#...#.#...#.#...#...#.....#...>.>.#.#.#.....###.........#...#.#...#...#.........#...#.#.......#.#.#.#.....#...#...###.#.#.>.#.......#...#
#.#.#.###.###.#.###.###.#.#########v###.#.#################.###.#.#################.#####.#######.#.#.#.#.###.###########.#.###v#.#########.#
#.#.#...#.#...#.....###.#.#.......#...#.#.....#...........#...#.#...#.........#...#.....#.#.......#...#...###...#...#...#.#.###...#.........#
#.#.###.#.#.###########.#.#.#####.###.#.#####.#.#########.###.#.###.#.#######.#.#.#####.#.#.###################.#.#.#.#.#.#.#######.#########
#.#.....#.#...........#...#...###.....#...#...#.........#.#...#.....#.......#...#...#...#.#.......#...#.....###...#...#.#.#.#.......###.....#
#.#######.###########.#######.###########.#.###########.#.#.###############.#######.#.###.#######.#.#.#.###.###########.#.#.#.#########.###.#
#...#...#...#.........#.......#...###...#.#.#...#.......#...#...###.....###.......#.#...#.#...#...#.#...#...#.......#...#.#.#.....#...#.#...#
###.#.#.###.#.#########.#######.#.###.#.#.#.#.#.#.###########.#.###.###.#########.#.###.#.#.#.#.###.#####.###.#####.#.###.#.#####.#.#.#.#.###
###...#...#...#...#...#.........#.#...#.#...#.#.#.............#...#...#.#.........#.....#...#...###.....#.....#...#.#...#...#...#...#...#...#
#########v#####.#.#.#.###########.#.###.#####.#.#################.###.#.#.#############################.#######.#.#.###.#####.#.###########.#
#.......#.>.#...#.#.#.#...........#...#.#...#.#.#...#.............#...#.#...........#.....#.....###...#.........#.#...#.#.....#...#...#.....#
#.#####.#v#.#.###.#.#.#.#############.#.#.#.#.#.#.#.#.#############.###.###########.#.###.#.###.###.#.###########.###.#.#.#######.#.#.#.#####
#.....#...#.#.#...#.#.#.........#...#.#.#.#.#.#.#.#.#.........#...#.#...#####.......#...#.#.#...#...#.#.........#...#...#.....###...#.#.....#
#####.#####.#.#.###.#.#########.#.#.#.#.#.#.#.#.#.#.#########.#.#.#.#.#######.#########.#.#.#.###.###.#.#######.###.#########.#######.#####.#
#.....#...#...#...#.#.###.......#.#.#.#.#.#.#.#.#.#.#.........#.#.#.#...#.....#...#...#.#.#.#.###...#.#.......#...#...###...#.......#.#...#.#
#.#####.#.#######.#.#.###.#######.#.#.#.#.#.#.#.#.#.#v#########.#.#.###.#.#####.#.#.#.#.#.#.#.#####.#.#######.###.###.###.#.#######.#.#.#.#.#
#.......#.#.....#...#...#.....###.#.#.#.#.#.#.#.#.#.>.>.....#...#.#...#.#.......#.#.#.#.#.#.#...#...#.#...#...###.....#...#.#.......#...#.#.#
#########.#.###.#######.#####.###.#.#.#.#.#.#.#.#.###v#####.#.###.###.#.#########.#.#.#.#.#.###.#.###.#.#.#.###########.###.#.###########.#.#
#...#...#.#...#.........###...#...#.#.#.#.#.#.#...###...#...#...#.###.#.#...#.....#.#.#.#.#.#...#...#.#.#.#.###...#...#...#.#.....#...###...#
#.#.#.#.#.###.#############.###.###.#.#.#.#.#.#########.#.#####.#.###.#.#.#.#v#####.#.#.#.#.#.#####.#.#.#.#v###.#.#.#.###.#.#####.#.#.#######
#.#...#.#...#.#...#...#...#...#...#.#.#...#.#.#.........#.....#.#...#.#.#.#.>.>.#...#.#.#.#.#.#...#.#.#.#.>.>.#.#.#.#.###.#.#.....#.#.......#
#.#####.###.#.#.#.#.#.#.#.###v###.#.#.#####.#.#.#############.#.###.#.#.#.###v#.#.###.#.#.#.#.#.#.#.#.#.###v#.#.#.#.#.###.#.#v#####.#######.#
#.....#.....#...#.#.#.#.#.#.>.>...#.#...###...#.............#.#.###.#.#...#...#.#.###.#.#.#.#.#.#...#...#...#.#.#.#.#.#...#.>.###...#.......#
#####.###########.#.#.#.#.#.#v#####.###.###################.#.#.###.#.#####.###.#.###.#.#.#.#.#.#########.###.#.#.#.#.#.#####v###.###.#######
#...#.....#.....#.#.#.#.#...#.....#.....#...#...............#...###...#...#.###...#...#.#...#...###...#...###.#.#.#.#.#.#.....###.#...###...#
#.#.#####.#.###.#.#.#.#.#########.#######.#.#.#########################.#.#.#######.###.###########.#.#.#####.#.#.#.#.#.#.#######.#.#####.#.#
#.#.......#.#...#.#.#.#.#.........#.......#.#...........###...#.........#.#.......#.#...#...........#...#...#.#.#.#.#...#...#...#.#.#...#.#.#
#.#########.#.###.#.#.#.#.#########.#######.###########.###.#.#.#########.#######.#.#.###.###############.#.#.#.#.#.#######.#.#.#.#.#.#.#.#.#
#...........#.###...#...#...........#...#...###.......#.....#.#.........#.........#...###.................#.#.#.#.#...#...#...#...#...#...#.#
#############.#######################.#.#.#####.#####.#######.#########.###################################.#.#.#.###.#.#.#################.#
#.......#...#...#...................#.#...#...#.....#.....#...#.....#...#.......#.....#...#.................#.#.#.....#.#.......#...#.....#.#
#.#####.#.#.###.#.#################.#.#####.#.#####.#####.#.###.###.#.###.#####.#.###.#.#.#.#################.#.#######.#######.#.#.#.###.#.#
#.....#...#.....#.....#.....#.....#.#...###.#.#####.....#...###...#.#.....#.....#.#...#.#.#.....#.........###...###...#...#...#.#.#...###...#
#####.###############.#.###.#.###.#.###.###.#.#########.#########.#.#######.#####.#.###.#.#####.#.#######.#########.#.###.#.#.#.#.###########
#.....#.............#.#.#...#.#...#.....#...#...#...###.......#...#.###...#.......#.....#.....#...###.....#.....#...#.###...#.#.#...........#
#.#####.###########.#.#.#.###.#.#########.#####.#.#.#########.#.###.###.#.###################.#######.#####.###.#.###.#######.#.###########.#
#...#...#...........#...#.....#.......#...#.....#.#...........#...#...#.#.......#.............#.....#.....#.#...#.#...#...#...#.............#
###.#.###.###########################.#.###.#####.###############.###.#.#######.#.#############.###.#####.#.#.###.#.###.#.#.#################
#...#.#...#.......#...###.............#...#...#...#.........#...#.#...#.......#.#.....###.....#...#.......#.#.....#.###.#.#...#.........#...#
#.###.#.###.#####.#.#.###.###############.###.#.###.#######.#.#.#.#.#########.#.#####.###.###.###.#########.#######.###.#.###.#.#######.#.#.#
#.....#...#.#.....#.#...#.......###...###...#.#.....###.....#.#.#.#.#...###...#.......#...#...###.........#.#.....#...#.#...#...#.....#...#.#
#########.#.#.#####.###.#######.###.#.#####.#.#########v#####.#.#.#.#.#.###v###########.###.#############.#.#.###.###.#.###.#####.###.#####.#
#.........#.#...###...#.#...#...#...#...#...#.#...#...>.>.#...#.#.#.#.#.#.>.>.#...#...#.#...#...###.......#.#...#.....#.#...#.....###.......#
#.#########.###.#####.#.#.#.#.###.#####.#.###.#.#.#.#####.#.###.#.#.#.#.#.###.#.#.#.#.#.#.###.#.###.#######.###.#######.#.###.###############
#.#...#...#.###...###.#.#.#.#...#.....#.#...#.#.#.#...###.#...#.#.#.#.#.#.###...#.#.#.#.#...#.#...#.....###...#.#.....#.#...#.........###...#
#.#.#.#.#.#.#####.###.#.#.#.###v#####.#.###.#.#.#.###.###.###.#.#.#.#.#.#.#######.#.#.#.###.#.###.#####.#####.#.#.###.#.###.#########.###.#.#
#.#.#.#.#.#...###...#.#.#.#.#.>.>...#.#...#.#.#.#.#...#...#...#.#.#...#.#.#...#...#.#.#.#...#.#...#...#.#...#.#.#.#...#.#...#...#...#.#...#.#
#.#.#.#.#.###.#####.#.#.#.#.#.#####.#.###.#.#.#.#.#.###.###.###.#.#####.#.#.#.#.###.#.#.#.###.#.###.#.#v#.#.#.#.#.#.###.#.###.#.#v#.#.#.###.#
#.#.#.#.#...#.#.....#.#.#.#.#.....#.#.#...#.#.#.#.#.###...#.###.#.#.....#.#.#...#...#.#.#...#.#...#.#.>.>.#.#.#.#.#...#.#.#...#.>.#...#...#.#
#.#.#.#.###.#.#.#####.#.#.#.#####.#.#.#.###.#.#.#.#.#####.#.###.#.#.#####.#.#####.###.#.###.#.###.#.#######.#.#.#.###.#.#.#.#####v#######.#.#
#...#...###...#.......#...#.......#...#.....#...#...#####...###...#.......#.......###...###...###...#######...#...###...#...#####.........#.#
###########################################################################################################################################.#
