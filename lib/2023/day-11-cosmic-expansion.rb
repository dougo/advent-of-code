class SpaceImage
  def initialize(text)
    @image = text.lines(chomp: true)
    @galaxies = @image.flat_map.with_index do |line, row|
      line.chars.filter_map.with_index do |char, col|
        Position[row, col] if char == '#'
      end
    end
    @empty_rows = (0...height).to_a - galaxies.map(&:row)
    @empty_cols = (0...width ).to_a - galaxies.map(&:col)
  end

  Position = Data.define(:row, :col)

  def height = @image.length
  def width = @image.first.length

  attr :galaxies, :empty_rows, :empty_cols

  def shortest_path_length(g1, g2, expansion_factor = 2)
    [g1, g2] => [row1, col1], [row2, col2]
    rows = [row1, row2].min ... [row1, row2].max
    cols = [col1, col2].min ... [col1, col2].max
    rows.size + cols.size +
      (expansion_factor - 1) * empty_rows.count { rows.include? _1 } +
      (expansion_factor - 1) * empty_cols.count { cols.include? _1 }
  end

  def sum_of_shortest_path_lengths(expansion_factor = 2)
    # This double-counts each pair of galaxies, so divide the total sum by 2.
    Enumerator.product(galaxies, galaxies).sum { shortest_path_length(_1, _2, expansion_factor) } / 2
  end
end

if defined? DATA
  image = SpaceImage.new(DATA.read)
  puts image.sum_of_shortest_path_lengths
  puts image.sum_of_shortest_path_lengths(1_000_000)
end

__END__
...........#..........#...........................#....................#......#........................................................#....
...#........................#..............................#...................................................................#............
......................................#...................................................................#...........#.....................
...............................................#...............#.......................#....................................................
..........................................#...........#.............................................#.......................................
..........#.................................................................#................................#..............................
................................#.................................................................................#......#..................
..................................................................#.........................................................................
............................................................#..................#.......................................................#....
................................................#............................................#...............................#..............
.....#..............#..............................................................#................................#.......................
.........................................#...............................................#.................................................#
..............................#................................#.......#....................................................................
........................................................................................................................#...................
...#......#.......#.................#...................#......................................#.......#.......#........................#...
...........................................#...............................#....................................................#...........
...................................................................................#........................................................
.............#............#........................................#.......................................#......#.........................
................................#............................#...............................#..............................................
........................................#.............#.........................#......#......................................#.............
........................................................................................................#.....#.............................
......#............#...............#..............#.........................................................................................
...........#..................#............#.....................#..................................................#.......................
.......................................................................#..................#................#.......................#........
..#...................................#.....................................#.....#..................#......................................
............................................................................................................................................
............................#........................#.........................................#............................................
.......#......................................................................................................................#.............
......................#.......................................................#.............................................................
.#...........................................................#.....#..................................................#.................#...
..................................#....................................................#....................................................
.................................................................................#..............................#...........................
........#.................................#..........#......................................#............#..................................
..................#........................................................#................................................................
.............................#................#......................#...............................#..........................#......#....
..............#......................#..................................................................................#...................
...............................................................................................................#............................
..#.....................#.......................................#...................................................#.......................
..................................#....................#..........................................#.........................................
....................#.....................#......#.........................................................................#.......#........
............................................................#..........#...................................................................#
....#........................#................................................#...........#...............#......#..........................
............................................................................................................................................
..........#............................#....................................................................................................
...............#...............................#......#.............................................#.................................#.....
......................#..........#.........................#.......#..................................................#.....................
...............................................................................................................#..................#........#
............................................................................................................................................
#..........................#...............................................#.......#......#.................................................
............................................................................................................................................
.......#......................................................#............................................................#........#.......
.............................................#.........#............................................#.....#.................................
...............................#.......#....................................................................................................
.................................................................#..........................#..................#............................
..............#.....#.........................................................#......#.....................................................#
.................................................#.......#.............#....................................................................
..............................................................#............................................#................................
.#.......................#...............#.................................#.........................................................#......
....................................#.....................................................#..............................#..................
.....#...........#..............................................................................#.....#.....................................
.................................................................#.................#........................................................
............................................................................................................................................
.................................................#........................................................#.................................
........#.........................................................................................#...........................#..........#..
...............#........#...........#.....#........................#..............................................#................#........
........................................................................................#...................................................
...................................................................................#.........................#..............................
...#..............#....................................................#............................#.......................................
..............................#............................#................................................................................
........................................#.............................................................................................#.....
..............................................#..................#.............#........................#.................#.................
...................................................#.............................................................#..........................
.........#..................................................................................................................................
.......................#.....................................#.......#.....#..............................................................#.
................................................................................................#.....................#.....................
....#...........................#......................#.............................#.......................................#..............
...........................................................................................................#................................
...........#.......#........#..............................#.....................................................#..........................
............................................#...............................................#...............................................
....................................................................#..............#..................#..............#...............#......
.....................................#........................#.............................................................................
...............................................#............................................................#.................#............#
............................................................................................................................................
....#.......#...........................................................................................................#.........#.........
...................................#................#...........#..............................#............................................
............................................................................................................................................
.......................................................................#...........#......#..........#.......#..............................
..............................................................................#......................................................#......
...........................#.....................#..................................................................#.......................
..#............#............................#................................................#..............................................
...........................................................................................................................................#
........................................#...............#............#..........#......................................#....................
............#................................................#..............................................................................
.......#............................#...............#....................................#............#..........................#..........
......................#....................................................#................................................................
...............................................................................................#.............#.....#........................
..................#....................................#.........#...............#..........................................................
.............#...............#................#........................................#.................................................#..
...................................#....................................................................#...................#...............
.........................................#..........#.................#.....................................................................
................#............................................................#..............................................................
..........#.....................#........................#.....................................................................#............
....#.................................#.............................................................................................#.......
......................#.....#.......................................................................................#.......................
..............................................#.........................................#...................................................
..........................................................................................................#.................................
...................................................................#.........................................................#..............
.........#....................#.........#.........#...........#....................................#......................................#.
............................................................................................................................................
..#........................................................................#...............#.............................#..................
..............#...........#..........................................................#..........................................#...........
...................#.................................#...............................................#......................................
...............................#......................................................................................................#.....
...........................................#.................#........#.......................#.............................................
.....................................#.....................................................................#......#.......#.................
................#...............................#................................#......#..........#......................................#.
........................#...................................................................................................................
..............................#................................................................................................#............
.........................................................#...................#..........................#...................................
....#.......................................................................................................................................
........................................................................#........................#......................#.............#.....
............#...............#.............#.........#............................#........#................#................................
.....................#...............#..............................................................................#.......................
..................................................................#......................................................................#..
............................................................................................................................................
..............#........................................#.....................#.......#......................................................
........................#..............................................#..............................................#........#............
........................................#........................................#..........................................................
.......#........................#...................#.........#..............................................#..............................
..#................#......................................................................#........................................#........
.................................................................................................#.......................#..................
..............................................#.............................................................................................
.....#........#...........................................................................................#.........#........#..............
.................................................................................#..........#..........................................#....
..........................#...................................#.........#..............#.........................................#..........
............................................................................................................................................
....................................................................#.......#...................#...........................................
......................#.............#.............#.....................................................#...................................
........................................................#........................................................#..........................
..#..........#..........................#....................................................................................#.......#......
