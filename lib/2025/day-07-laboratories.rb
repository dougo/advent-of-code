require_relative '../util'

class Laboratories < Grid
  attr :row, :num_beam_splits, :num_copies

  def initialize(*args)
    super
    @row = 0
    @num_beam_splits = 0
    start_col = rows.first.chars.find_index('S')
    @num_copies = Hash.new(0)
    num_copies[start_col] = 1
    propagate!
  end

  def cols = num_copies.keys

  def propagate!
    return if row >= height
    @row += 1
    cols.dup.each do |col|
      pos = Position[row,col]
      case self[pos]
      when '.'
        self[pos] = '|'
      when '^'
        num_copies[col - 1] += num_copies[col]
        num_copies[col + 1] += num_copies[col]
        num_copies.delete(col)
        @num_beam_splits += 1
      end
    end
    propagate!
  end

  def num_timelines
    num_copies.values.sum
  end
end

if defined? DATA
  input = DATA.read
  obj = Laboratories.parse(input)
  puts obj.num_beam_splits
  puts obj.num_timelines
end

__END__
......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^.^...^...................................................................
.............................................................................................................................................
..................................................................^.^.^.^.^..................................................................
.............................................................................................................................................
.................................................................^.^.^.^...^.................................................................
.............................................................................................................................................
................................................................^.^...^.^.^.^................................................................
.............................................................................................................................................
...............................................................^...^...^...^.^...............................................................
.............................................................................................................................................
..............................................................^.^.^.^.^.^...^.^..............................................................
.............................................................................................................................................
.............................................................^.....^.^.^.^...^.^.............................................................
.............................................................................................................................................
............................................................^.^.^.^.^.^...^.^...^............................................................
.............................................................................................................................................
...........................................................^...^.^.^.^.^...^.^.^.^...........................................................
.............................................................................................................................................
..........................................................^...^.^...^.^.^.....^...^..........................................................
.............................................................................................................................................
.........................................................^.^.^...^.^.^...^.^.^.^.^.^.........................................................
.............................................................................................................................................
........................................................^...^...^.^.^.^.^...^...^...^........................................................
.............................................................................................................................................
.......................................................^.........^.^.^.^.^.....^.^.^.^.......................................................
.............................................................................................................................................
......................................................^.....^.^.^.^...^.^...^...^.....^......................................................
.............................................................................................................................................
.....................................................^.^.^.^.^...^...^.^.....^...^.^.^.^.....................................................
.............................................................................................................................................
....................................................^...^.^...^...^...^.^.^...^.......^.^....................................................
.............................................................................................................................................
...................................................^.^.....^.^.^.^...^.^...^.^.....^.^...^...................................................
.............................................................................................................................................
..................................................^.^.^.^.^...^...^...^.^.^...^.^.^.^...^.^..................................................
.............................................................................................................................................
.................................................^.^.......^.....^.^...^.^.^.....^...^.....^.................................................
.............................................................................................................................................
................................................^.^.....^...^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^................................................
.............................................................................................................................................
...............................................^.^.....^.^.^.^...^.^.^.^.^.^.^.^.^.....^.^.^.^...............................................
.............................................................................................................................................
..............................................^.....^.^.^.^...^.^...^.^.^.^.^.....^.^.^.^.^...^..............................................
.............................................................................................................................................
.............................................^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^.............................................
.............................................................................................................................................
............................................^.^.......^...^.^.^.^.....^.^...^...^...........^.^.^............................................
.............................................................................................................................................
...........................................^.^.^.^.^.^.^...^...^.^.^...^.^.......^...^.^.^.^.^.^.^...........................................
.............................................................................................................................................
..........................................^.^...^.^.^.^.^.^.....^.^.....^.^.^.^.^.^.^.^...^.^...^.^..........................................
.............................................................................................................................................
.........................................^.^.^.^...^...^.......^.^.^.^.^.^.^.^.^...^...^.^.....^.^.^.........................................
.............................................................................................................................................
........................................^.^...^.^.........^.^.....^...^.^...^...^.^...^...^.^.^...^.^........................................
.............................................................................................................................................
.......................................^.^.^.....^.^.^...^.......^.^.^.^.^...^.^.....^.^.^.^.^.^...^.^.......................................
.............................................................................................................................................
......................................^.^.^.^.^...^.......^.^.^...^.^...^.^.^.^.^...^...^.^.^.^...^...^......................................
.............................................................................................................................................
.....................................^.^.^.^.^...^.^.^...^.....^.........^.....^.^.^...^.^.....^...^.^.^.....................................
.............................................................................................................................................
....................................^.^...^.^.^.^.^.^.^.^...^.........^.....^...^.^.....^.^.^.^...^...^.^....................................
.............................................................................................................................................
...................................^...^.^.^.^.^.^.^.^...^.....^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^...................................
.............................................................................................................................................
..................................^.^.^...^.^.^...^...^.^.^.^.^.^...^.^...^.^.^.^.^.^.^.^.^...^.^.........^..................................
.............................................................................................................................................
.................................^.^.^.^.^.^.^.^...^.^.^.....^.^...^.^.^.^...^.^.^...^.^.^.^.^.....^.^.^.^.^.................................
.............................................................................................................................................
................................^...^.^.......^.....^...^.^...^...^.^.^...^.^.^.........^.^.^.^...^.^.^.^.^.^................................
.............................................................................................................................................
...............................^.^.^.^.^.^.^.....^.^.^.........^...^.^.^.^.^...^.^.^.^.^.....^...^.^.^.^.^.^.^...............................
.............................................................................................................................................
..............................^.^.^...^.^...^.......^.^.^.^...^.....^...^.....^...^...^.^.^...^.^.^...^...^...^..............................
.............................................................................................................................................
.............................^.^.^.........^...^.^.^.^.^.^.......^.^.^.^...^.....^.^.^.^.^.^.......^.^.^.^...^.^.............................
.............................................................................................................................................
............................^...^.^...^.^.^.^...^.^.^...^.^.^.^.....^.^.^.^.^...^.....^.^.^.....^.^.^...^.^.^.^.^............................
.............................................................................................................................................
...........................^.^.^.^...^.^.^.^.^.^.^.^.^.^.....^.^...^.^.^...^.^.^...^.^...^.^.^.^.^.^...^.^...^.^.^...........................
.............................................................................................................................................
..........................^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^...^.^.^.......^.^...^.^.^.^.^.^.........^...^.^...^.^..........................
.............................................................................................................................................
.........................^.^.^...^.....^.....^.^.^.^.......^...^.^.^.^.^.....^...^.^.^.^.^...........^...^.^...^.^.^.........................
.............................................................................................................................................
........................^.^.^.^.....^...^.^.^...^.^.^...^.^.^.^...........^...^.^.^.^.....^...^.^.^.^.^.^.^...^.^.^.^........................
.............................................................................................................................................
.......................^.^.^.^...^.^.^.^.^.^.....^.....^.^.^.^.^...^...^.^.^.^...^.^.^...^.^.^.^.^.....^.....^.^.^.^.^.......................
.............................................................................................................................................
......................^.^...^...^.^...^...^.^.^.^.^.......^.^.......^.^.^...^.......^.^...^.^...^.....^.^...^.^.....^.^......................
.............................................................................................................................................
.....................^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^.......^.^.^...^.^.^.....^.^.^...^.........^.^...^.^.^...^.^.^...^.....................
.............................................................................................................................................
....................^...^.....^.^.....^.....^.......^.^.^.....^.^.^.^.^...^...^...^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.^.^....................
.............................................................................................................................................
...................^.^.^...........^...^.^.^.^.^.^.....^.......^.^.^.^.....^.^.....^...^.^...^...^.....^.^.^.^.^.......^.^...................
.............................................................................................................................................
..................^.....^...^.^.^.....^...^.....^.^.^.^...........^.^.^.^.^.^.^...^.^...^...^.^.^.^.^.^.^.^.^.^.^...^...^.^..................
.............................................................................................................................................
.................^.^.^.^.^.^...^.^...^.^...^.^.^.^.^...^.^.^.^.^...^.^.....^...^.^.^.^...^.^.^.^...^.^.^.^.^...^.....^.....^.................
.............................................................................................................................................
................^.^.^.......^.^...^.^.^.....^...^.^.......^...^.^...^...^...^...^.^.^.^.^.^...^.^...^.^.^...^.^...^.^.^.^.^.^................
.............................................................................................................................................
...............^...^.^.^.^...^.^...^.^.^.^.......^.................^.^...^.^.^.^...^.^.^.^...^...^.^.^...^...^.^.^.^.^.....^.^...............
.............................................................................................................................................
..............^.^.^.^...^...^.^.^.^.^.^.^...^.^.......^.^.^.^.^.^.......^.....^.^.^.^.^.^...^.^.^.^.........^.....^.^.....^...^..............
.............................................................................................................................................
.............^.....^...^...^...^.......^.^...^.^...........^.^.^.....^...^.^...^.^...^...^.....^.^.^...^...^.....^...^.^.^...^.^.............
.............................................................................................................................................
............^.....^.......^.^.^.^.^.^.^...^...^.......^.^...^.^.^...^.^.^.^.^.^...^...^.^.....^...^.^...^.^.^.^.^.......^.^.^...^............
.............................................................................................................................................
...........^.^...^.^.^...^.^.^.....^.^.^.^.......^.^.^.^...^.^...^.^.^...^.^...^...^...^.^.^.^.......^.^.^.^.^.^.^.^.^.^...^.^.^.^...........
.............................................................................................................................................
..........^.^.......^.^.^.^.^.^.^...^.^.^...^.^.^.^.....^.^.^...^...^...^.^.^.^...^.^.^.^.^.^...^.^.^...^.^...^.^.^...^...^.^.^...^..........
.............................................................................................................................................
.........^.^.^.^.^.^...^.....^.....^.^.^...^.^.^...^.^.^.^.^.^.^.^...^.^.^.....^.^.^...^.^.....^.^.^.^.....^.^...^.^.^.^...^...^.^.^.........
.............................................................................................................................................
........^...^.^.^...^.^.^.^...^.^.^.^...........^.^.^...^.^.^.....^...^.....^.^...^.^.^.^.^...^.^.^.^.^...^.^...^...^.^.^.^.^.^...^.^........
.............................................................................................................................................
.......^.....^.^.^.^...^.^.^...^.^.^.^.^.....^.....^.....^.^.^.....^.^.....^...^.^...^.^.^.^.^.^.^.^...^.^.....^.^.^.^...^.^.^...^.^.^.......
.............................................................................................................................................
......^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^...^.^...^.....^.^...^.^.^.^.......^.^.^.^.....^...^.^...^.^...^.^.^.^.^.^.^.^.^...^.^......
.............................................................................................................................................
.....^.^.^.^...^.^.^...^.^.^.^.....^.^.^.^.^...^.....^.....^.^.^.^...^...^.^.^.^.^.......^...^.^.^.......^.^...^.^.^.....^.^.^...^.^.^.^.....
.............................................................................................................................................
....^.^.^.^...^.^.^.^.....^.^...^...^...^.^.^...^.^.^.^.^.^...^.......^...^.^.^.^.^...^...^.^.......^.^.^.^.^.^.^.^.^...^.^.......^.^...^....
.............................................................................................................................................
...^...^...^.^...^...........^.^.^.^...^...^.^.^...^.....^.....^.^.^.^...^.^.^.........^.^.^.^.^.....^...^.^...^.....^.^...^...^.....^.^.^...
.............................................................................................................................................
..^.....^.^...^.......^...^.^...^...^.^...^...^...^...^.^.^.^.^.....^.^.^.^...^.^...^.^.^.^.......^.^.^...........^.....^...^.^...........^..
.............................................................................................................................................
.^.....^.^.^.^.^...^...^.^.^.^.......^.^.....^...^.^.^...^.....^.^.^.^.^.......^.^.....^...^.^.^.^.^.........^.....^.^.^...^.^.^.......^.^.^.
.............................................................................................................................................
